<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MemOS Monitor</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --bg: hwb(242 3% 91%);
        --bg-glass: rgba(10, 10, 25, 0.7);
        --bg-card: rgba(255, 255, 255, 0.03);
        --bg-hover: rgba(255, 255, 255, 0.06);
        --bg-input: rgba(255, 255, 255, 0.05);
        --accent: #00ffcc;
        --accent-rgb: 0, 255, 204;
        --accent-dim: rgba(0, 255, 204, 0.15);
        --text: #f0f0f5;
        --text-dim: #94a3b8;
        --ok: #10b981;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 16px;
        --glass: 20px;
        --sidebar-w: 72px;
        --font: "Inter", -apple-system, system-ui, sans-serif;
        --mono: "JetBrains Mono", "Fira Code", monospace;
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }
      
      /* custom scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

      html, body {
        height: 100%;
        background: var(--bg);
        background-image: 
          radial-gradient(at 0% 0%, hsla(242, 30%, 15%, 1) 0, transparent 50%),
          radial-gradient(at 100% 100%, hsla(168, 100%, 10%, 1) 0, transparent 50%);
        color: var(--text);
        font-family: var(--font);
        font-size: 14px;
        overflow: hidden;
      }

      /* layout */
      .app {
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-w);
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 24px 0;
        gap: 12px;
        flex-shrink: 0;
        z-index: 500;
      }
      .sidebar button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 14px;
        background: transparent;
        color: var(--text-dim);
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .sidebar button:hover {
        background: var(--bg-hover);
        color: var(--text);
        transform: translateY(-2px);
      }
      .sidebar button.active {
        background: var(--accent-dim);
        color: var(--accent);
        box-shadow: 0 0 15px var(--accent-dim);
      }
      .sidebar button .tip {
        position: absolute;
        left: 64px;
        background: #1a1a2e;
        color: var(--text);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s;
        z-index: 2000;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow);
        transform: translateX(-10px);
      }
      .sidebar button:hover .tip {
        opacity: 1;
        transform: translateX(0);
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 32px;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .header h1 {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: -0.5px;
      }
      .header h1 span {
        font-size: 24px;
        filter: drop-shadow(0 0 8px var(--accent-dim));
      }
      .refresh-ctl {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-dim);
        font-size: 13px;
      }
      .refresh-ctl select {
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 12px;
        outline: none;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      .refresh-ctl select:hover {
        border-color: var(--accent);
      }
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
        scroll-behavior: smooth;
        position: relative;
      }
      
      /* toast */
      #toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        min-width: 250px;
        background: var(--bg-glass);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        color: #fff;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: toastIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 4px solid var(--accent);
      }
      .toast.err { border-left-color: var(--err); }
      .toast.warn { border-left-color: var(--warn); }
      @keyframes toastIn {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      /* empty state */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--text-dim);
        text-align: center;
      }
      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
      }
      .empty-state .text {
        font-size: 14px;
        max-width: 300px;
        line-height: 1.5;
      }
      .statusbar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 8px 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 11px;
        color: var(--text2);
      }
      .statusbar .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--ok);
        display: inline-block;
        box-shadow: 0 0 10px var(--ok);
      }
      .statusbar .dot.pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
      }

      /* cards */
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .card {
        background: var(--bg-card);
        backdrop-filter: blur(var(--glass));
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        padding: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .card::before {
        content: "";
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 4px;
        background: linear-gradient(90deg, transparent, var(--accent), transparent);
        opacity: 0;
        transition: opacity 0.3s;
      }
      .card:hover {
        background: var(--bg-hover);
        transform: translateY(-4px);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .card:hover::before {
        opacity: 1;
      }
      .card .icon {
        font-size: 24px;
        margin-bottom: 12px;
        filter: drop-shadow(0 0 10px rgba(var(--accent-rgb), 0.3));
      }
      .card .value {
        font-size: 32px;
        font-weight: 800;
        font-family: var(--mono);
        color: #fff;
        line-height: 1;
      }
      .card .label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-dim);
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .card .sub {
        font-size: 11px;
        color: var(--text-dim);
        margin-top: 4px;
        opacity: 0.7;
      }
      .card.err .value {
        color: var(--err);
      }
      .card.err::before {
        background: linear-gradient(90deg, transparent, var(--err), transparent);
      }

      /* section */
      .section {
        display: none;
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .section.active {
        display: block;
      }
      .section-title {
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section-title::after {
        content: "";
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, var(--accent-dim), transparent);
      }

      /* logs */
      .log-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        align-items: center;
      }
      .log-filters button {
        padding: 6px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-dim);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
      }
      .log-filters button:hover {
        background: var(--bg-hover);
        color: var(--text);
      }
      .log-filters button.active {
        background: var(--accent-dim);
        color: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent-dim);
      }
      .log-search {
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 13px;
        width: 280px;
        margin-left: auto;
        transition: all 0.2s;
      }
      .log-search:focus {
        border-color: var(--accent);
        background: rgba(var(--accent-rgb), 0.04);
        outline: none;
      }
      .log-table {
        width: 100%;
      }
      .log-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        margin-bottom: 4px;
      }
      .log-row:hover {
        background: var(--bg-hover);
        border-color: rgba(255, 255, 255, 0.05);
      }
      .log-row .time {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text-dim);
        min-width: 80px;
        flex-shrink: 0;
      }
      .badge {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        flex-shrink: 0;
        box-shadow: 0 0 5px currentColor;
      }
      .badge.normal { color: var(--ok); background: var(--ok); }
      .badge.heartbeat { color: var(--warn); background: var(--warn); }
      .badge.error { color: var(--err); background: var(--err); }
      
      .log-row .type {
        font-size: 12px;
        font-weight: 600;
        min-width: 120px;
        flex-shrink: 0;
        font-family: var(--mono);
        color: var(--text);
      }
      .log-row .preview {
        font-size: 13px;
        color: var(--text-dim);
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .log-row .dur {
        font-size: 12px;
        color: var(--accent);
        font-family: var(--mono);
        min-width: 60px;
        text-align: right;
        font-weight: 600;
      }
      .log-details {
        display: none;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        margin: 4px 0 12px;
        font-family: var(--mono);
        font-size: 11px;
        white-space: pre-wrap;
        word-break: break-all;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-dim);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
      }
      .log-details.open {
        display: block;
      }

      /* config */
      .cfg-group {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: var(--radius);
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .cfg-group-header {
        padding: 16px 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
        font-size: 14px;
        color: var(--text);
        background: rgba(255,255,255,0.01);
        transition: all 0.2s;
        user-select: none;
      }
      .cfg-group-header:hover {
        background: var(--bg-hover);
        color: var(--accent);
      }
      .cfg-group-header .arrow {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 10px;
        color: var(--text-dim);
      }
      .cfg-group-header.open .arrow {
        transform: rotate(90deg);
        color: var(--accent);
      }
      .cfg-group-body {
        padding: 0 24px 24px;
        display: none;
        animation: slideDown 0.3s ease-out;
      }
      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .cfg-group-body.open {
        display: block;
      }
      .cfg-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        gap: 12px;
      }
      .cfg-row:last-child {
        border-bottom: none;
      }
      .cfg-row label {
        font-size: 13px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .cfg-row .hint {
        font-size: 11px;
        color: var(--text2);
        margin-left: 8px;
      }
      /* toggle */
      .toggle {
        position: relative;
        width: 40px;
        height: 22px;
        flex-shrink: 0;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle .slider {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 22px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .toggle .slider::before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 3px;
        bottom: 3px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.2s;
      }
      .toggle input:checked + .slider {
        background: var(--accent);
      }
      .toggle input:checked + .slider::before {
        transform: translateX(18px);
      }
      .cfg-row .toggle-wrap {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
      }
      /* number input */
      .num-input {
        width: 70px;
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 13px;
        font-family: var(--mono);
        text-align: center;
      }
      /* select */
      .cfg-select {
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
      }
      /* chips */
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }
      .chip {
        display: flex;
        align-items: center;
        gap: 4px;
        background: var(--accent-dim);
        color: var(--accent);
        padding: 3px 10px;
        border-radius: 16px;
        font-size: 12px;
        font-family: var(--mono);
      }
      .chip button {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        padding: 0 2px;
      }
      .chip-add {
        display: flex;
        gap: 6px;
        margin-top: 8px;
      }
      .chip-add input {
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        width: 180px;
      }
      .chip-add button {
        background: var(--accent-dim);
        color: var(--accent);
        border: 1px solid var(--accent);
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
      }
      /* actions */
      .actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        position: sticky;
        bottom: -32px; /* Pull down to content edge */
        background: rgba(10, 10, 25, 0.2);
        backdrop-filter: blur(10px);
        padding: 16px 24px;
        margin-left: -24px;
        margin-right: -24px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 10;
      }
      .btn {
        padding: 8px 20px;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--accent);
        color: #000;
      }
      .btn-primary:hover {
        filter: brightness(1.1);
      }
      .btn-secondary {
        background: transparent;
        color: var(--text2);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .btn-secondary:hover {
        background: var(--bg-hover);
      }
      .btn:disabled {
        opacity: 0.4;
        cursor: default;
      }
      .save-ok {
        color: var(--ok);
        font-size: 12px;
        margin-left: 8px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .save-ok.show {
        opacity: 1;
      }

      /* prompt editor */
      .prompt-presets {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .prompt-presets button {
        padding: 12px 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-dim);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        flex: 1;
        text-align: left;
      }
      .prompt-presets button:hover {
        background: var(--bg-hover);
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.15);
      }
      .prompt-presets button.active {
        background: var(--accent-dim);
        color: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 0 15px var(--accent-dim);
      }
      .prompt-presets button .desc {
        display: block;
        font-size: 11px;
        color: var(--text-dim);
        margin-top: 4px;
        font-weight: 400;
        opacity: 0.8;
      }
      .prompt-editor {
        position: relative;
      }
      .prompt-editor textarea {
        width: 100%;
        min-height: 400px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.6;
        padding: 24px;
        border-radius: var(--radius);
        resize: vertical;
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
      }
      .prompt-editor textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 15px var(--accent-dim);
      }
      .prompt-toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
        font-size: 11px;
        color: var(--text2);
      }
      .prompt-vars {
        margin-top: 16px;
      }
      .prompt-vars h3 {
        font-size: 12px;
        color: var(--text2);
        margin-bottom: 8px;
      }
      .var-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 6px 14px;
        border-radius: 10px;
        font-family: var(--mono);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        margin: 4px;
        transition: all 0.2s;
        color: var(--text-dim);
      }
      .var-chip:hover {
        background: var(--accent-dim);
        color: var(--accent);
        transform: scale(1.05);
      }
      .preview-pane {
        margin-top: 16px;
      }
      .preview-pane summary {
        font-size: 12px;
        color: var(--text2);
        cursor: pointer;
        margin-bottom: 8px;
      }
      .preview-pane pre {
        background: var(--bg-input);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: var(--radius);
        padding: 16px;
        font-family: var(--mono);
        font-size: 11px;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .note {
        background: rgba(0, 255, 204, 0.05);
        border-left: 4px solid var(--accent);
        padding: 12px 16px;
        border-radius: 4px 12px 12px 4px;
        font-size: 13px;
        color: var(--text-dim);
        margin-bottom: 24px;
        line-height: 1.5;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .app { flex-direction: column-reverse; }
        .sidebar {
          width: 100%;
          height: 64px;
          flex-direction: row;
          justify-content: space-around;
          padding: 0;
          border-right: none;
          border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .sidebar button .tip { display: none; }
        .header { padding: 12px 20px; }
        .content { padding: 20px; }
        .cards { grid-template-columns: 1fr; }
        .log-search { width: 100%; margin-top: 12px; }
        .log-filters { gap: 8px; }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <nav class="sidebar">
        <button class="active" data-tab="overview" title="Overview">
          <span>üìä</span><span class="tip">Vue d'ensemble</span>
        </button>
        <button data-tab="logs" title="Logs">
          <span>üìã</span><span class="tip">Journal</span>
        </button>
        <button data-tab="config" title="Config">
          <span>‚öôÔ∏è</span><span class="tip">Configuration</span>
        </button>
        <button data-tab="prompt" title="Prompt Editor">
          <span>‚úèÔ∏è</span><span class="tip">√âditeur de prompt</span>
        </button>
      </nav>

      <div class="main">
        <!-- Header -->
        <header class="header">
          <h1><span>üß†</span> MemOS Monitor</h1>
          <div class="refresh-ctl">
            <span>Auto-refresh:</span>
            <select id="refreshInterval">
              <option value="5000">5s</option>
              <option value="15000" selected>15s</option>
              <option value="30000">30s</option>
              <option value="0">Off</option>
            </select>
          </div>
        </header>

        <!-- Content -->
        <div class="content" id="content">
          <!-- OVERVIEW -->
          <div class="section active" id="sec-overview">
            <div class="cards" id="statsCards"></div>
            <div class="section-title">Activit√© r√©cente</div>
            <div id="recentLogs"></div>
          </div>

          <!-- LOGS -->
          <div class="section" id="sec-logs">
            <div class="log-filters" id="logFilters">
              <button class="active" data-filter="all">Tous</button>
              <button data-filter="normal">Normaux</button>
              <button data-filter="heartbeat">Heartbeats</button>
              <button data-filter="error">Erreurs</button>
              <input
                class="log-search"
                id="logSearch"
                placeholder="Rechercher‚Ä¶"
                type="text"
              />
            </div>
            <div id="logList"></div>
          </div>

          <!-- CONFIG -->
          <div class="section" id="sec-config">
            <div class="note">
              Les modifications prennent effet au red√©marrage d'OpenClaw.
            </div>
            <div id="configForm"></div>
            <div class="actions">
              <button class="btn btn-primary" id="cfgSave" disabled>
                üíæ Sauvegarder
              </button>
              <button class="btn btn-secondary" id="cfgReset">
                ‚Ü© R√©initialiser
              </button>
              <span class="save-ok" id="cfgSaveOk">‚úì Sauvegard√©</span>
            </div>
          </div>

          <!-- PROMPT EDITOR -->
          <div class="section" id="sec-prompt">
            <div class="prompt-presets" id="promptPresets">
              <button class="active" data-style="default">
                Verbeux (d√©faut)
                <span class="desc">Prompt complet MemOS (~50 lignes)</span>
              </button>
              <button data-style="compact">
                Compact
                <span class="desc">Version concise (~12 lignes)</span>
              </button>
              <button data-style="custom">
                Custom
                <span class="desc">Votre prompt personnalis√©</span>
              </button>
            </div>
            <div class="prompt-toolbar">
              <span id="promptStats">0 lignes ¬∑ 0 caract√®res</span>
              <button
                class="btn btn-secondary"
                id="promptCopy"
                style="padding: 3px 10px; font-size: 11px"
              >
                üìã Copier
              </button>
              <button
                class="btn btn-secondary"
                id="promptRestore"
                style="padding: 3px 10px; font-size: 11px"
              >
                ‚Ü© Restaurer
              </button>
            </div>
            <div class="prompt-editor">
              <textarea id="promptText" spellcheck="false"></textarea>
            </div>
            <div class="prompt-vars">
              <h3>Variables disponibles (cliquer pour ins√©rer)</h3>
              <span class="var-chip" data-var="{memories}">üì¶ {memories}</span>
              <span class="var-chip" data-var="{currentTime}"
                >üïê {currentTime}</span
              >
              <span class="var-chip" data-var="{userQueryMarker}"
                >üîñ {userQueryMarker}</span
              >
            </div>
            <details class="preview-pane">
              <summary>Aper√ßu du prompt g√©n√©r√©</summary>
              <pre id="promptPreview"></pre>
            </details>
            <div class="actions">
              <button class="btn btn-primary" id="promptSave" disabled>
                üíæ Sauvegarder
              </button>
              <span class="save-ok" id="promptSaveOk">‚úì Sauvegard√©</span>
            </div>
          </div>
        </div>

        <!-- Status bar -->
        <div class="statusbar">
          <span><span class="dot" id="statusDot"></span></span>
          <span id="statusText">Connecting‚Ä¶</span>
        </div>
      </div>
    </div>

    <script>
      (function () {
        // --- State ---
        let refreshTimer = null;
        let currentTab = "overview";
        let currentLogFilter = "all";
        let runtimeConfig = {};
        let configOverrides = {};
        let configDirty = false;
        let promptStyle = "default";
        let promptDirty = false;
        let lastStats = null;
        let lastUpdate = 0;
        const openLogIds = new Set();

        const DEFAULT_PROMPT = `# Role\n\nYou are an intelligent assistant with long-term memory capabilities (MemOS Assistant). Your goal is to combine retrieved memory fragments to provide highly personalized, accurate, and logically rigorous responses.\n\n# System Context\n\n* Current Time: {currentTime} (Use this as the baseline for freshness checks)\n\n# Memory Data\n\nBelow is the information retrieved by MemOS, categorized into "Facts" and "Preferences".\n* **Facts**: May include user attributes, historical conversations, or third-party details.\n* **Special Note**: Content tagged with '[assistantËßÇÁÇπ]' or '[Ê®°ÂûãÊÄªÁªì]' represents **past AI inference**, **not** direct user statements.\n* **Preferences**: The user's explicit or implicit requirements on response style, format, or reasoning.\n\n{memories}\n\n# Critical Protocol: Memory Safety\n\nRetrieved memories may contain **AI speculation**, **irrelevant noise**, or **wrong subject attribution**. You must strictly apply the **Four-Step Verdict**. If any step fails, **discard the memory**:\n\n1. **Source Verification**:\n* **Core**: Distinguish direct user statements from AI inference.\n* If a memory has tags like '[assistantËßÇÁÇπ]' or '[Ê®°ÂûãÊÄªÁªì]', treat it as a **hypothesis**, not a user-grounded fact.\n* *Counterexample*: If memory says '[assistantËßÇÁÇπ] User loves mangoes' but the user never said that, do not assume it as fact.\n* **Principle: AI summaries are reference-only and have much lower authority than direct user statements.**\n\n2. **Attribution Check**:\n* Is the subject in memory definitely the user?\n* If the memory describes a **third party** (e.g., candidate, interviewee, fictional character, case data), never attribute it to the user.\n\n3. **Strong Relevance Check**:\n* Does the memory directly help answer the current 'Original Query'?\n* If it is only a keyword overlap with different context, ignore it.\n\n4. **Freshness Check**:\n* If memory conflicts with the user's latest intent, prioritize the current 'Original Query' as the highest source of truth.\n\n# Instructions\n\n1. **Review**: Read '<facts>' first and apply the Four-Step Verdict to remove noise and unreliable AI inference.\n2. **Execute**:\n   - Use only memories that pass filtering as context.\n   - Strictly follow style requirements from '<preferences>'.\n3. **Output**: Answer directly. Never mention internal terms such as "memory store", "retrieval", or "AI opinions".\n4. **Attention**: Additional memory context is already provided. Do not read from or write to local \`MEMORY.md\` or \`memory/*\` files for reference, as they may be outdated or irrelevant to the current query.\n{userQueryMarker}`;

        const COMPACT_PROMPT = `You have long-term memory. Use the retrieved facts and preferences below to personalise your response.\n\nCurrent Time: {currentTime}\n\n{memories}\n\nGuidelines:\n- Discard any memory that is irrelevant, misattributed, or conflicts with the user's current query.\n- Content tagged '[assistantËßÇÁÇπ]' or '[Ê®°ÂûãÊÄªÁªì]' is past AI inference ‚Äî treat as low-confidence.\n- Prioritise the current query over older memories.\n- Follow style/format requirements from <preferences>.\n- Never mention memory retrieval internals to the user.\n- Do not read or write local MEMORY.md / memory/* files.\n{userQueryMarker}`;

        const API = "";

        // --- Notifications ---
        function toast(msg, type = "info") {
          const container = $("#toast-container") || createToastContainer();
          const t = document.createElement("div");
          t.className = `toast ${type}`;
          const icon = type === "err" ? "‚ö†Ô∏è" : type === "warn" ? "üîî" : "‚úÖ";
          t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
          container.appendChild(t);
          setTimeout(() => {
            t.style.opacity = "0";
            t.style.transform = "translateX(50px)";
            t.style.transition = "all 0.3s";
            setTimeout(() => t.remove(), 300);
          }, 4000);
        }

        function createToastContainer() {
          const c = document.createElement("div");
          c.id = "toast-container";
          document.body.appendChild(c);
          return c;
        }

        // --- Helpers ---
        async function api(path, opts = {}) {
          const res = await fetch(API + path, opts);
          return res.json();
        }

        function $(sel) {
          return document.querySelector(sel);
        }
        function $$(sel) {
          return document.querySelectorAll(sel);
        }

        function fmtTime(iso) {
          if (!iso) return "";
          const d = new Date(iso);
          return d.toLocaleTimeString("fr-FR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }

        function fmtUptime(iso) {
          if (!iso) return "‚Äì";
          const ms = Date.now() - new Date(iso).getTime();
          const s = Math.floor(ms / 1000);
          const m = Math.floor(s / 60);
          const h = Math.floor(m / 60);
          const d = Math.floor(h / 24);
          if (d > 0) return `${d}j ${h % 24}h ${m % 60}m`;
          if (h > 0) return `${h}h ${m % 60}m`;
          return `${m}m ${s % 60}s`;
        }

        function badgeClass(type) {
          if (type === "heartbeat_filtered") return "heartbeat";
          if (type.includes("error")) return "error";
          return "normal";
        }

        // --- Tabs ---
        $$(".sidebar button").forEach((btn) => {
          btn.addEventListener("click", () => {
            currentTab = btn.dataset.tab;
            $$(".sidebar button").forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            $$(".section").forEach((s) => s.classList.remove("active"));
            $(`#sec-${currentTab}`).classList.add("active");
            if (currentTab === "logs") loadLogs();
            if (currentTab === "config") loadConfig();
            if (currentTab === "prompt") loadPrompt();
          });
        });

        // --- Overview ---
        function renderStats(data) {
          const s = data.stats;
          lastStats = s;
          const errClass = s.errors > 0 ? " err" : "";
          $("#statsCards").innerHTML = `
      <div class="card"><div class="icon">‚ö°</div><div class="value">${s.totalEvents}</div><div class="label">Total events</div><div class="sub">depuis le d√©marrage</div></div>
      <div class="card"><div class="icon">üõ°Ô∏è</div><div class="value">${s.heartbeatsFiltered}</div><div class="label">Heartbeats filtr√©s</div><div class="sub">${s.totalEvents > 0 ? Math.round((s.heartbeatsFiltered / s.totalEvents) * 100) : 0}% du total</div></div>
      <div class="card"><div class="icon">üîó</div><div class="value">${s.searchCalls + s.addCalls}</div><div class="label">Appels API MemOS</div><div class="sub">search: ${s.searchCalls} / add: ${s.addCalls}</div></div>
      <div class="card${errClass}"><div class="icon">${s.errors > 0 ? "‚ö†Ô∏è" : "‚úÖ"}</div><div class="value">${s.errors}</div><div class="label">Erreurs</div><div class="sub">${s.errors === 0 ? "Aucune erreur" : "Voir les logs"}</div></div>
    `;
        }

        function renderRecentLogs(logs) {
          if (!logs || !logs.length) {
            $("#recentLogs").innerHTML = `
              <div class="empty-state">
                <div class="icon">üîç</div>
                <div class="text">Aucun √©v√©nement enregistr√© pour le moment. Votre activit√© appara√Ætra ici.</div>
              </div>
            `;
            return;
          }
          $("#recentLogs").innerHTML = logs
            .slice(0, 10)
            .map(
              (l) => `
      <div class="log-row" data-id="${l.id}">
        <span class="time">${fmtTime(l.timestamp)}</span>
        <span class="badge ${badgeClass(l.type)}"></span>
        <span class="type">${l.type}</span>
        <span class="preview">${esc(l.promptPreview || "‚Äì")}</span>
        <span class="dur">${l.durationMs != null ? l.durationMs + "ms" : ""}</span>
      </div>
    `,
            )
            .join("");
        }

        async function loadOverview() {
          const dot = $("#statusDot");
          dot.classList.add("pulse");
          try {
            const data = await api("/api/stats");
            renderStats(data);
            renderRecentLogs(data.logs);
            lastUpdate = Date.now();
            dot.style.background = "var(--ok)";
            dot.style.boxShadow = "0 0 10px var(--ok)";
            $("#statusText").textContent =
              `Op√©rationnel ¬∑ Uptime: ${fmtUptime(data.stats.startedAt)}`;
          } catch (e) {
            dot.style.background = "var(--err)";
            dot.style.boxShadow = "0 0 10px var(--err)";
            $("#statusText").textContent = "Hors ligne ¬∑ Probl√®me de connexion";
          } finally {
            setTimeout(() => dot.classList.remove("pulse"), 1000);
          }
        }

        // --- Logs ---
        async function loadLogs() {
          const search = ($("#logSearch")?.value || "").toLowerCase();
          const data = await api(
            `/api/logs?type=${currentLogFilter}&limit=100`,
          );
          let logs = data.logs || [];
          if (search)
            logs = logs.filter(
              (l) =>
                (l.promptPreview || "").toLowerCase().includes(search) ||
                l.type.includes(search),
            );
          renderLogList(logs);
        }

        function renderLogList(logs) {
          if (!logs.length) {
            $("#logList").innerHTML = `
              <div class="empty-state">
                <div class="icon">üì≠</div>
                <div class="text">Aucun log ne correspond √† votre recherche ou filtre.</div>
              </div>
            `;
            return;
          }
          $("#logList").innerHTML = logs
            .map(
              (l) => `
      <div class="log-row" onclick="toggleLog(${l.id}, this)" data-id="${l.id}">
        <span class="time">${fmtTime(l.timestamp)}</span>
        <span class="badge ${badgeClass(l.type)}"></span>
        <span class="type">${l.type}</span>
        <span class="preview">${esc(l.promptPreview || "‚Äì")}</span>
        <span class="dur">${l.durationMs != null ? l.durationMs + "ms" : ""}</span>
      </div>
      <div class="log-details ${openLogIds.has(l.id) ? "open" : ""}">${esc(JSON.stringify(l, null, 2))}</div>
    `,
            )
            .join("");
        }

        window.toggleLog = function (id, el) {
          const details = el.nextElementSibling;
          details.classList.toggle("open");
          if (details.classList.contains("open")) {
            openLogIds.add(id);
          } else {
            openLogIds.delete(id);
          }
        };

        // Log filter buttons
        $$("#logFilters button").forEach((btn) => {
          btn.addEventListener("click", () => {
            currentLogFilter = btn.dataset.filter;
            $$("#logFilters button").forEach((b) =>
              b.classList.remove("active"),
            );
            btn.classList.add("active");
            loadLogs();
          });
        });
        $("#logSearch")?.addEventListener("input", () => loadLogs());

        // --- Config ---
        async function loadConfig() {
          const data = await api("/api/config");
          runtimeConfig = data.runtime || {};
          configOverrides = data.overrides || {};
          renderConfigForm();
        }

        function cfgVal(key) {
          return configOverrides[key] !== undefined
            ? configOverrides[key]
            : runtimeConfig[key];
        }

        function renderConfigForm() {
          const html = `
      ${cfgGroup(
        "Filtres heartbeat",
        `
        ${cfgToggle("ignoreHeartbeats", "Ignorer les heartbeats", "Filtre les messages heartbeat avant les appels API")}
        <div class="cfg-row" style="flex-direction:column;align-items:flex-start">
          <label>Mots-cl√©s de d√©tection</label>
          <div class="chips" id="kwChips">${(cfgVal("heartbeatKeywords") || []).map((kw) => `<span class="chip">${esc(kw)}<button onclick="removeKw(this, '${esc(kw)}')">&times;</button></span>`).join("")}</div>
          <div class="chip-add"><input id="kwInput" placeholder="Ajouter un mot-cl√©‚Ä¶"><button onclick="addKw()">+ Ajouter</button></div>
        </div>
        ${cfgToggle("debugEvents", "Mode debug", "Logue la structure des events dans la console")}
      `,
      )}
      ${cfgGroup(
        "M√©moire MemOS",
        `
        ${cfgToggle("recallEnabled", "Recall activ√©", "Recherche de m√©moires")}
        ${cfgToggle("addEnabled", "Add activ√©", "Sauvegarde des conversations")}
        ${cfgNumber("memoryLimitNumber", "Limite de m√©moires", 1, 30)}
        ${cfgToggle("includePreference", "Inclure pr√©f√©rences")}
        ${cfgNumber("preferenceLimitNumber", "Limite de pr√©f√©rences", 1, 30)}
        ${cfgToggle("includeAssistant", "Inclure r√©ponses assistant")}
        ${cfgSelect("captureStrategy", "Strat√©gie de capture", [
          ["last_turn", "Dernier tour"],
          ["full_session", "Session compl√®te"],
        ])}
      `,
      )}
      ${cfgGroup(
        "Avanc√©",
        `
        ${cfgNumber("timeoutMs", "Timeout API (ms)", 1000, 30000)}
        ${cfgNumber("retries", "Retries", 0, 5)}
        ${cfgNumber("throttleMs", "Throttle (ms)", 0, 60000)}
        ${cfgNumber("maxMessageChars", "Max chars/message", 1000, 100000)}
      `,
      )}
    `;
          $("#configForm").innerHTML = html;
          configDirty = false;
          $("#cfgSave").disabled = true;
        }

        function cfgGroup(title, body) {
          return `<div class="cfg-group">
      <div class="cfg-group-header" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        ${title}<span class="arrow">‚ñ∂</span>
      </div>
      <div class="cfg-group-body">${body}</div>
    </div>`;
        }
        function cfgToggle(key, label, hint) {
          const val = cfgVal(key);
          const checked = val ? "checked" : "";
          return `<div class="cfg-row">
            <label>${label}${hint ? `<span class="hint">${hint}</span>` : ""}</label>
            <div class="toggle-wrap">
              <label class="toggle"><input type="checkbox" ${checked} onchange="setCfg('${key}', this.checked)"><span class="slider"></span></label>
            </div>
          </div>`;
        }
        function cfgNumber(key, label, min, max) {
          const val = cfgVal(key) ?? "";
          return `<div class="cfg-row"><label>${label}</label>
      <input class="num-input" type="number" min="${min}" max="${max}" value="${val}" onchange="setCfg('${key}', +this.value)"></div>`;
        }
        function cfgSelect(key, label, options) {
          const val = cfgVal(key);
          const opts = options
            .map(
              ([v, l]) =>
                `<option value="${v}" ${v === val ? "selected" : ""}>${l}</option>`,
            )
            .join("");
          return `<div class="cfg-row"><label>${label}</label><select class="cfg-select" onchange="setCfg('${key}', this.value)">${opts}</select></div>`;
        }

        // Global config functions (called from inline handlers)
        window.setCfg = function (key, val) {
          configOverrides[key] = val;
          configDirty = true;
          $("#cfgSave").disabled = false;
          $("#cfgSaveOk").classList.remove("show");
        };
        window.removeKw = function (btn, kw) {
          const kws = (cfgVal("heartbeatKeywords") || []).filter(
            (k) => k !== kw,
          );
          configOverrides.heartbeatKeywords = kws;
          btn.closest(".chip").remove();
          configDirty = true;
          $("#cfgSave").disabled = false;
        };
        window.addKw = function () {
          const inp = $("#kwInput");
          const kw = (inp.value || "").trim();
          if (!kw) return;
          const kws = cfgVal("heartbeatKeywords") || [];
          if (!kws.includes(kw)) {
            kws.push(kw);
            configOverrides.heartbeatKeywords = kws;
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.innerHTML = `${esc(kw)}<button onclick="removeKw(this, '${esc(kw)}')">&times;</button>`;
            $("#kwChips").appendChild(chip);
            configDirty = true;
            $("#cfgSave").disabled = false;
          }
          inp.value = "";
        };

        $("#cfgSave")?.addEventListener("click", async () => {
          try {
            const res = await api("/api/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(configOverrides),
            });
            if (res.error) {
              toast(res.error, "err");
            } else {
              configDirty = false;
              $("#cfgSave").disabled = true;
              toast("Configuration sauvegard√©e avec succ√®s");
            }
          } catch (e) {
            toast("Erreur lors de la sauvegarde", "err");
          }
        });

        $("#cfgReset")?.addEventListener("click", async () => {
          if (!confirm("R√©initialiser la config aux valeurs par d√©faut ?"))
            return;
          try {
            await api("/api/config", { method: "DELETE" });
            toast("Configuration r√©initialis√©e");
            loadConfig();
          } catch (e) {
            toast("Erreur lors de la r√©initialisation", "err");
          }
        });

        // --- Prompt ---
        async function loadPrompt() {
          const data = await api("/api/config");
          const ov = data.overrides || {};
          promptStyle =
            ov.promptStyle || data.runtime?.promptStyle || "default";
          activatePresetBtn(promptStyle);

          if (promptStyle === "custom" && ov.promptTemplate) {
            $("#promptText").value = ov.promptTemplate;
          } else if (promptStyle === "compact") {
            $("#promptText").value = COMPACT_PROMPT;
          } else {
            $("#promptText").value = DEFAULT_PROMPT;
          }
          updatePromptStats();
          promptDirty = false;
          $("#promptSave").readOnly = promptStyle !== "custom";
          $("#promptSave").disabled = true;
          loadPreview();
        }

        function activatePresetBtn(style) {
          $$("#promptPresets button").forEach((b) => {
            b.classList.toggle("active", b.dataset.style === style);
          });
          $("#promptText").readOnly = style !== "custom";
        }

        $$("#promptPresets button").forEach((btn) => {
          btn.addEventListener("click", async () => {
            promptStyle = btn.dataset.style;
            activatePresetBtn(promptStyle);
            if (promptStyle === "default") {
              $("#promptText").value = DEFAULT_PROMPT;
            } else if (promptStyle === "compact") {
              $("#promptText").value = COMPACT_PROMPT;
            } else {
              // Switch to custom: keep text or restore if empty
              if (!$("#promptText").value) {
                const data = await api("/api/config");
                $("#promptText").value =
                  data.overrides?.promptTemplate || DEFAULT_PROMPT;
              }
            }
            updatePromptStats();
            promptDirty = true;
            $("#promptSave").disabled = false;
            loadPreview();
          });
        });

        $("#promptText")?.addEventListener("input", () => {
          updatePromptStats();
          promptDirty = true;
          $("#promptSave").disabled = false;
          loadPreview();
        });

        function updatePromptStats() {
          const t = $("#promptText").value;
          const lines = t.split("\n").length;
          const chars = t.length;
          $("#promptStats").textContent =
            `${lines} lignes ¬∑ ${chars} caract√®res`;
        }

        async function loadPreview() {
          const style = promptStyle;
          const template = style === "custom" ? $("#promptText").value : null;
          try {
            const pv = await api("/api/prompt/preview", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ style, template }),
            });
            $("#promptPreview").textContent = pv.preview || "";
          } catch {}
        }

        $("#promptSave")?.addEventListener("click", async () => {
          try {
            await api("/api/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                promptStyle,
                promptTemplate: promptStyle === "custom" ? $("#promptText").value : null,
              }),
            });
            promptDirty = false;
            $("#promptSave").disabled = true;
            toast("Prompt sauvegard√© avec succ√®s");
          } catch (e) {
            toast("Erreur lors de la sauvegarde du prompt", "err");
          }
        });

        window.insertVar = function (v) {
          const area = $("#promptText");
          if (area.readOnly) {
            toast("Changez le preset en 'Custom' pour √©diter le texte", "warn");
            return;
          }
          const start = area.selectionStart;
          const end = area.selectionEnd;
          const text = area.value;
          area.value = text.slice(0, start) + v + text.slice(end);
          area.focus();
          area.selectionStart = area.selectionEnd = start + v.length;
          updatePromptStats();
          promptDirty = true;
          $("#promptSave").disabled = false;
        };

        // Variable chips
        $$(".var-chip").forEach((chip) => {
          chip.addEventListener("click", () => {
            insertVar(chip.dataset.var);
          });
        });

        $("#promptCopy")?.addEventListener("click", () => {
          navigator.clipboard.writeText($("#promptText").value);
        });

        $("#promptRestore")?.addEventListener("click", () => {
          if (confirm("Restaurer le prompt par d√©faut ?")) {
            promptStyle = "default";
            activatePresetBtn("default");
            loadPrompt();
          }
        });

        $("#promptSave")?.addEventListener("click", async () => {
          const ov = { ...configOverrides, promptStyle };
          if (promptStyle === "custom") {
            ov.promptTemplate = $("#promptText").value;
          } else {
            delete ov.promptTemplate;
          }
          await api("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(ov),
          });
          configOverrides = ov;
          promptDirty = false;
          $("#promptSave").disabled = true;
          const ok = $("#promptSaveOk");
          ok.classList.add("show");
          setTimeout(() => ok.classList.remove("show"), 2000);
        });

        // --- Auto-refresh ---
        function startRefresh() {
          const ms = parseInt($("#refreshInterval").value, 10);
          if (refreshTimer) clearInterval(refreshTimer);
          if (ms > 0) {
            refreshTimer = setInterval(() => {
              loadOverview();
              if (currentTab === "logs") loadLogs();
            }, ms);
          }
        }

        $("#refreshInterval")?.addEventListener("change", startRefresh);

        // --- Helpers ---
        function esc(str) {
          if (!str) return "";
          return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        // --- Init ---
        loadOverview();
        startRefresh();
      })();
    </script>
  </body>
</html>
